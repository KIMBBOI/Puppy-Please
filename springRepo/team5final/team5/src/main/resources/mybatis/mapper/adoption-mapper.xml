<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AdoptionMapper">

    <!-- 입양 신청 리스트 조회 -->
    <select id="list" resultType="com.kh.app.adoption.vo.AdoptionVo">
    	SELECT *
    	FROM (
	        SELECT ROWNUM RNUM, T.*
	        FROM (
	        	SELECT
		        	A.ADOPTION_BOARD_NO
		        	, A.ADMIN_NO
		        	, A.ADOPTION_COMPLETE_YN
				    , A.DEL_YN
				    , RD.IMAGE_NO 
				    , RD.DOG_NAME
				    , RD.BREED
				    , RD.GENDER_MF
				    , RD.NEUTERING_OX
				    , RD.AGE
				    , RD.WEIGHT
				    , I.IMAGE_PATH
				FROM
				    ADOPTION_BOARD A
					JOIN RESCUE_DOG RD 
						ON A.RESCUE_DOG_NO = RD.RESCUE_DOG_NO
					JOIN IMAGE I
				  		ON I.IMAGE_NO = RD.IMAGE_NO
				WHERE
				    A.DEL_YN = 'N'
				ORDER BY
				    A.ENROLL_DATE DESC
	    	) T
		)
    </select>
    
    <select id='listCount' resultType="Integer">
		SELECT 
			COUNT(*) as cnt 
		FROM 
			ADOPTION_BOARD 
		WHERE 
			DEL_YN = 'N'
		AND
			ADOPTION_COMPLETE_YN = 'N'
	</select>

    <!-- 입양 신청 상세 조회 -->
    <select id="detail" resultType="com.kh.app.adoption.vo.AdoptionVo">
         SELECT
	        A.ADOPTION_BOARD_NO,
	        A.ADMIN_NO,
	        A.DEL_YN,
	        RD.IMAGE_NO,
	        RD.DOG_NAME,
	        RD.BREED,
	        RD.GENDER_MF,
	        RD.NEUTERING_OX,
	        RD.AGE,
	        RD.WEIGHT,
	        I.IMAGE_PATH
	    FROM
	        ADOPTION_BOARD A
	    JOIN
	        RESCUE_DOG RD ON A.RESCUE_DOG_NO = RD.RESCUE_DOG_NO
	    JOIN
	        IMAGE I ON I.IMAGE_NO = RD.IMAGE_NO
	    WHERE
	        A.DEL_YN = 'N'
	        AND A.ADOPTION_BOARD_NO = #{adoptionBoardNo}
    </select>
    
    <!-- 입력한 견종에 해당하는 RESCUE_DOG_NO 가져오기 -->
    <select id="findDogNoByBreed" resultType="java.lang.String">
    	SELECT 
    		SEQ_RESCUE_DOG_NO.CURRVAL
	    FROM 
	    	DUAL
    </select>
    
    <!-- 게시글 작성 -->
    <insert id="write" >
		INSERT INTO ADOPTION_BOARD
        (
            ADOPTION_BOARD_NO
            , IMAGE_NO
            , RESCUE_DOG_NO
            , ADMIN_NO
        )
        VALUES
        (
            SEQ_ADOPTION_BOARD_NO.NEXTVAL
            , #{imageNo}
            , #{rescueDogNo}
            , #{adminNo}
        ) 
	</insert>

    <!-- 이미지 업로드 -->
    <insert id="insert">
    	INSERT INTO IMAGE
		(
			IMAGE_NO
			,IMAGE_PATH
		)
		VALUES
		(
			SEQ_IMAGE_NO.NEXTVAL
			,#{imagePath}
		)
    </insert>
   
	<!-- 이미지 시퀀스 가져오는 쿼리문  -->
	<select id="imageSeqNo"  resultType="java.lang.String">
		SELECT 
			SEQ_IMAGE_NO.CURRVAL
		FROM 
			DUAL
	</select>

    <!-- 입양 신청 수정 -->
    <update id="edit" parameterType="com.kh.app.adoption.vo.AdoptionVo">
        UPDATE 
        	ADOPTION_BOARD
        SET 
        	IMAGE_NO = #{imageNo}
            , RESCUE_DOG_NO = #{rescueDogNo}
            , ADMIN_NO = #{adminNo}
            , ENROLL_DATE = #{enrollDate}
            , MODIFY_DATE = #{modifyDate}
            , ADOPTION_COMPLETE_YN = #{adoptionCompleteYn}
            , DEL_YN = #{delYn}
        WHERE 
        	ADOPTION_BOARD_NO = #{adoptionBoardNo}
    </update>
    
    <!-- 입양신청 -> 입양완료 -->
    <update id="adoptionOk">
    	UPDATE 
    		ADOPTION_BOARD
    	SET
    		ADOPTION_COMPLETE_YN = 'Y'
    	WHERE
    		ADOPTION_BOARD_NO = {adoptionBoardNo}
    </update>

    <!-- 입양 신청 삭제 -->
    <update id="delete">
        UPDATE 
        	ADOPTION_BOARD
        SET 
        	DEL_YN = 'Y'
        WHERE 
        	ADOPTION_BOARD_NO = #{adoptionBoardNo}
    </update>
	
	<!-- 관리자가 입양하기->입양신청-> 등록하기클릭 후 입력한 정보부터 입력 -->
	<insert id="insertRescueDog">
    	INSERT INTO RESCUE_DOG
		(
			RESCUE_DOG_NO
			, IMAGE_NO
			, BREED
			, ADMISSION_DATE
			, DOG_NAME
			, AGE
			, GENDER_MF
			, NEUTERING_OX
			, WEIGHT
		)
		VALUES
		(
			SEQ_RESCUE_DOG_NO.NEXTVAL
			, #{imageNo}
			, #{breed}
			, SYSDATE
			, #{dogName}
			, #{age}
			, #{genderMf}
			, #{neuteringOx}
			, #{weight}
		)
    </insert>
	
</mapper>

